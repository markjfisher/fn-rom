---
alwaysApply: false
---
# FujiNet BBC Micro ROM Project

Building a sideways ROM for BBC micro that uses FujiNet (ESP32 network device) instead of SD cards.

## Key Projects
- **fn-rom/**: Our FujiNet ROM source code  
- **MMFS/**: Reference implementation (SD-based file system)

## Core Principles
- **Follow MMFS closely**: Use `mmfs100.asm` as primary reference (assume `_MM32_` true)
- **Only deviate** for network vs SD-specific implementation details
- **Test with dummy**: Use `fuji_dummy.s` for testing (in-memory disk simulation)

## Critical Architecture Patterns
**Transaction Management**: All high-level disk operations must follow consistent pattern:
- `fuji_read_block`: `fuji_begin_transaction` → operation → `fuji_end_transaction`  
- `fuji_write_block`: `fuji_begin_transaction` → operation → `fuji_end_transaction`
- `fuji_read_catalogue`: `fuji_begin_transaction` → operation → `fuji_end_transaction`

**MMFS has two transaction mechanisms**:
1. OSWORD 7F: Always calls `MMC_BEGIN2` (low-level disk ops)
2. Command dispatch: Uses bit 15 to selectively call `MMC_BEGIN2` (high-level commands)

## Debugging Regressions
Look for:
- Incomplete TODOs not setting workspace variables correctly
- Missing `fuji_begin_transaction` calls before `fuji_end_transaction`  
- Deviations from MMFS memory address patterns
